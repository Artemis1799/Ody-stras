<p-drawer [(visible)]="visible" position="right" [modal]="false" [closeOnEscape]="false" [dismissible]="false">
  <ng-template #header>
    <div class="drawer-header">
      <h3>Éditer le point</h3>
      <button 
        type="button" 
        class="p-button-text p-button-rounded close-button"
        (click)="closeDrawer()"
      >✕</button>
    </div>
  </ng-template>

  <div *ngIf="selectedPoint" class="drawer-content">
    <div class="form-field">
      <label for="comment">Commentaire</label>
      <input 
        id="comment" 
        type="text" 
        pInputText 
        [(ngModel)]="editedComment"
        placeholder="Entrez un commentaire"
        class="w-full"
      />
    </div>

    <div class="form-field">
      <div class="checkbox-field">
        <p-checkbox 
          inputId="isValid" 
          [(ngModel)]="editedIsValid"
          [binary]="true"
        ></p-checkbox>
        <label for="isValid">Point validé</label>
      </div>
    </div>

    <div class="form-field">
      <label for="equipment">Équipement</label>
      <p-select
        inputId="equipment"
        [options]="equipments"
        [(ngModel)]="selectedEquipment"
        optionLabel="description"
        placeholder="Sélectionner un équipement"
        [showClear]="true"
        (onChange)="onEquipmentChange($event)"
        class="w-full"
      >
        <ng-template #value let-value>
          <div *ngIf="value">{{ getEquipmentDisplayName(value) }}</div>
        </ng-template>
        <ng-template #item let-equipment>
          <div>
            {{ getEquipmentDisplayName(equipment) }}
            <span class="stock-info" *ngIf="equipment.remainingStock !== undefined">
              (Stock: {{ equipment.remainingStock }})
            </span>
          </div>
        </ng-template>
      </p-select>
    </div>

    <div class="form-field" *ngIf="selectedEquipment">
      <label for="quantity">Quantité</label>
      <p-inputnumber
        inputId="quantity"
        [(ngModel)]="editedEquipmentQuantity"
        [min]="0"
        [max]="getAvailableStock()"
        (ngModelChange)="onQuantityChange($event)"
        [showButtons]="true"
        class="w-full"
      ></p-inputnumber>
      <small class="stock-indicator">
        Stock disponible: {{ getAvailableStock() }}
      </small>
    </div>

    <div class="form-field point-info">
      <h4>Informations</h4>
      <p><strong>UUID:</strong> {{ selectedPoint.uuid }}</p>
      <p *ngIf="selectedPoint.latitude && selectedPoint.longitude">
        <strong>Position:</strong> {{ selectedPoint.latitude }}, {{ selectedPoint.longitude }}
      </p>
      <p><strong>Ordre:</strong> {{ selectedPoint.order }}</p>
    </div>
  </div>

  <ng-template #footer>
    <div class="drawer-footer">
      <button 
        type="button" 
        class="photo-button"
        (click)="loadPhotosForPoint()"
        [disabled]="loadingPhotos"
      >
        <span class="pi pi-image"></span>
        {{ loadingPhotos ? 'Chargement...' : 'Voir photos' }}
      </button>
      <div class="action-buttons">
        <button 
          type="button" 
          class="delete-button"
          (click)="deletePoint()"
        >
          <span class="pi pi-trash"></span>
          Supprimer
        </button>
        <button 
          type="button" 
          class="save-button"
          (click)="saveChanges()"
        >
          <span class="pi pi-check"></span>
          Enregistrer
        </button>
      </div>
    </div>
  </ng-template>
</p-drawer>

<!-- Dialog pour afficher les photos -->
<p-dialog 
  [(visible)]="showPhotoDialog" 
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '900px'}"
  styleClass="photo-dialog"
  header="Photos du point"
>
  <!-- État de chargement -->
  <div *ngIf="loadingPhotos" class="loading-state">
    <div class="loading-spinner">
      <span class="pi pi-spin pi-spinner"></span>
    </div>
    <p class="loading-text">Chargement des photos...</p>
  </div>

  <!-- Affichage des photos -->
  <div class="photo-viewer" *ngIf="!loadingPhotos && currentPhoto">
    <div class="photo-container">
      <img 
        [src]="getPhotoSrc(currentPhoto)" 
        [alt]="currentPhoto.pictureName"
        class="photo-image"
      />
    </div>
    
    <div class="photo-navigation">
      <button 
        type="button"
        class="nav-button"
        (click)="previousPhoto()"
        [disabled]="currentPhotoIndex === 0"
      >
        <span class="pi pi-chevron-left"></span>
      </button>
      
      <span class="photo-counter">{{ photoCountText }}</span>
      
      <button 
        type="button"
        class="nav-button"
        (click)="nextPhoto()"
        [disabled]="currentPhotoIndex === photos.length - 1"
      >
        <span class="pi pi-chevron-right"></span>
      </button>
    </div>
    
    <div class="photo-info">
      <p>{{ currentPhoto.pictureName }}</p>
    </div>
  </div>
  
  <!-- Aucune photo -->
  <div *ngIf="!loadingPhotos && !currentPhoto" class="no-photos">
    <div class="no-photos-icon">
      <span class="pi pi-image"></span>
    </div>
    <h3 class="no-photos-title">Aucune photo disponible</h3>
    <p class="no-photos-text">Ce point ne contient pas encore de photos.</p>
  </div>
</p-dialog>
