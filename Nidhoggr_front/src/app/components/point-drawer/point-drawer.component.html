<p-drawer 
  [(visible)]="visible"
  position="right" 
  [modal]="false" 
  [closeOnEscape]="false" 
  [dismissible]="false"
  [closable]="false"
>
  <ng-template #header>
    <div class="drawer-header">
      <div class="header-content">
        <h3>Point #{{ selectedPoint?.order || '?' }}</h3>
        <span class="point-status" [class.valid]="editedIsValid" [class.invalid]="!editedIsValid">
          {{ editedIsValid ? 'Validé' : 'Non validé' }}
        </span>
      </div>
      <button 
        type="button" 
        class="close-button"
        (click)="closeDrawer()"
        title="Fermer"
      >✕</button>
    </div>
  </ng-template>

  <ng-container *ngIf="selectedPoint" class="drawer-content">
    <!-- Section Validation -->
    <div class="section">
      <div class="section-header">
        <span class="pi pi-check-circle"></span>
        <h4>Validation</h4>
      </div>
      <div class="checkbox-field">
        <p-checkbox 
          inputId="isValid" 
          [(ngModel)]="editedIsValid"
          [binary]="true"
        ></p-checkbox>
        <label for="isValid">Marquer ce point comme validé</label>
      </div>
    </div>

    <!-- Section Commentaire -->
    <div class="section">
      <div class="section-header">
        <span class="pi pi-comment"></span>
        <h4>Commentaire</h4>
      </div>
      <input 
        id="comment" 
        type="text" 
        pInputText 
        [(ngModel)]="editedComment"
        placeholder="Ajouter un commentaire..."
        class="w-full"
      />
    </div>

    <!-- Section Équipement -->
    <div class="section">
      <div class="section-header">
        <span class="pi pi-box"></span>
        <h4>Équipement</h4>
      </div>
      
      <div class="form-field">
        <label for="equipment">Type d'équipement</label>
        <p-select
          inputId="equipment"
          [options]="equipments"
          [(ngModel)]="selectedEquipment"
          optionLabel="description"
          placeholder="Sélectionner..."
          [showClear]="true"
          (onChange)="onEquipmentChange($event)"
          class="w-full"
        >
          <ng-template #value let-value>
            <div *ngIf="value">{{ getEquipmentDisplayName(value) }}</div>
          </ng-template>
          <ng-template #item let-equipment>
            <div class="equipment-option">
              <span class="equipment-name">{{ getEquipmentDisplayName(equipment) }}</span>
              <span class="equipment-stock" *ngIf="equipment.remainingStock !== undefined">
                Stock: {{ equipment.remainingStock }}
              </span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="form-field" *ngIf="selectedEquipment">
        <label for="quantity">Quantité</label>
        <p-inputnumber
          inputId="quantity"
          [(ngModel)]="editedEquipmentQuantity"
          [min]="0"
          [max]="getAvailableStock()"
          (ngModelChange)="onQuantityChange($event)"
          [showButtons]="true"
          class="w-full"
        ></p-inputnumber>
        <small class="help-text">
          <span class="pi pi-info-circle"></span>
          Stock disponible: {{ getAvailableStock() }}
        </small>
      </div>
    </div>

    <!-- Section Informations -->
    <div class="section info-section">
      <div class="section-header">
        <span class="pi pi-info-circle"></span>
        <h4>Informations</h4>
      </div>
      <div class="info-grid">
        <div class="info-item full-width">
          <span class="info-label">Position</span>
          <span class="info-value" *ngIf="selectedPoint.latitude && selectedPoint.longitude">
            {{ selectedPoint.latitude.toFixed(6) }}, {{ selectedPoint.longitude.toFixed(6) }}
          </span>
          <span class="info-value empty" *ngIf="!selectedPoint.latitude || !selectedPoint.longitude">
            Non définie
          </span>
        </div>
        <div class="info-item full-width">
          <span class="info-label">Ordre</span>
          <span class="info-value">{{ selectedPoint.order }}</span>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #footer>
    <div class="drawer-footer">
      <button 
        type="button" 
        class="btn btn-secondary"
        (click)="loadPhotosForPoint()"
        [disabled]="loadingPhotos"
      >
        <span class="pi pi-image"></span>
        {{ loadingPhotos ? 'Chargement...' : 'Photos' }}
      </button>
      <div class="main-actions">
        <button 
          type="button" 
          class="btn btn-danger"
          (click)="deletePoint()"
        >
          <span class="pi pi-trash"></span>
          Supprimer
        </button>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="saveChanges()"
        >
          <span class="pi pi-save"></span>
          Enregistrer
        </button>
      </div>
    </div>
  </ng-template>
</p-drawer>

<!-- Dialog pour afficher les photos -->
<p-dialog 
  [(visible)]="showPhotoDialog" 
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '900px'}"
  styleClass="photo-dialog"
  header="Photos du point"
>
  <!-- État de chargement -->
  <div *ngIf="loadingPhotos" class="loading-state">
    <div class="loading-spinner">
      <span class="pi pi-spin pi-spinner"></span>
    </div>
    <p class="loading-text">Chargement des photos...</p>
  </div>

  <!-- Affichage des photos -->
  <div class="photo-viewer" *ngIf="!loadingPhotos && currentPhoto">
    <div class="photo-container">
      <img 
        [src]="getPhotoSrc(currentPhoto)" 
        [alt]="currentPhoto.pictureName"
        class="photo-image"
      />
    </div>
    
    <div class="photo-navigation">
      <button 
        type="button"
        class="nav-button"
        (click)="previousPhoto()"
        [disabled]="currentPhotoIndex === 0"
      >
        <span class="pi pi-chevron-left"></span>
      </button>
      
      <span class="photo-counter">{{ photoCountText }}</span>
      
      <button 
        type="button"
        class="nav-button"
        (click)="nextPhoto()"
        [disabled]="currentPhotoIndex === photos.length - 1"
      >
        <span class="pi pi-chevron-right"></span>
      </button>
    </div>
    
    <div class="photo-info">
      <p>{{ currentPhoto.pictureName }}</p>
    </div>
  </div>
  
  <!-- Aucune photo -->
  <div *ngIf="!loadingPhotos && !currentPhoto" class="no-photos">
    <div class="no-photos-icon">
      <span class="pi pi-image"></span>
    </div>
    <h3 class="no-photos-title">Aucune photo disponible</h3>
    <p class="no-photos-text">Ce point ne contient pas encore de photos.</p>
  </div>
</p-dialog>
