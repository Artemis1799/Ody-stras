<div class="timeline-container" [class.sidebar-collapsed]="sidebarCollapsed" *ngIf="isVisible">
  <div class="timeline-dialog">
    <!-- Contr√¥les de filtres -->
    <div class="filter-controls">
      <div class="filter-buttons">
        <button 
          class="filter-toggle" 
          [class.active]="dateFilterActive"
          (click)="toggleDateFilter()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          {{ dateFilterActive ? 'Filtre date' : 'Date off' }}
        </button>
        <button 
          class="filter-toggle geo-filter" 
          [class.active]="geoFilterActive"
          (click)="toggleGeoFilter()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          {{ geoFilterActive ? 'Filtre g√©ospatial' : 'G√©ospatial off' }}
        </button>
        
        <span class="selected-date" *ngIf="selectedDate && dateFilterActive">
          üìÖ {{ formatDateTime(selectedDate) }}
        </span>
      </div>

      <div class="filter-buttons-right">
        <!-- Bouton d'assignation d'√©quipe -->
        <button 
          class="filter-toggle assign-team-btn" 
          [class.active]="getSelectedCount() > 0"
          [disabled]="getSelectedCount() === 0"
          (click)="openTeamAssignModal()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Assigner ({{ getSelectedCount() }})
        </button>

        <!-- Filtre par type d'√©quipement √† droite du bouton Assigner -->
        <div class="equipment-filter-inline" *ngIf="availableEquipmentTypes.length > 0">
          <label for="equipmentTypeSelect" class="filter-label">Type d'√©quipement</label>
          <select 
            id="equipmentTypeSelect"
            class="equipment-select"
            [(ngModel)]="selectedEquipmentType"
            (ngModelChange)="onEquipmentTypeChange()"
          >
            <option value="all">Tous les types</option>
            <option *ngFor="let type of availableEquipmentTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>
      </div>
      <button class="timeline-close" (click)="close()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="timeline-content" *ngIf="allZones.length > 0; else noZonesAtAll">
      <!-- Axe temporel TOUJOURS visible pour permettre le drag -->
      <div 
        class="timeline-axis-wrapper"
        #timelineWrapper
        (mousedown)="onAxisMouseDown($event)"
        (mousemove)="onAxisMouseMove($event)"
        (mouseup)="onAxisMouseUp()"
        (mouseleave)="onAxisMouseUp()"
        [class.dragging-active]="isDragging"
      >
        <!-- Tout s√©lectionner √† gauche de la timeline axis -->
        <div class="select-all-with-timeline" *ngIf="filteredZones.length > 0">
          <input 
            type="checkbox" 
            id="selectAllZones"
            class="zone-checkbox"
            [checked]="areAllZonesSelected()"
            (change)="toggleSelectAll()"
          />
          <label for="selectAllZones" class="select-all-label">Tout s√©lectionner</label>
        </div>

        <div class="timeline-axis-container" #timelineAxis>
          <div class="timeline-graduations">
            <div
              class="graduation"
              *ngFor="let grad of graduations"
              [style.left.%]="grad.position"
              [title]="grad.label"
            >
              <div class="graduation-tick"></div>
              <div class="graduation-label">{{ grad.label }}</div>
            </div>
          </div>
          
          <!-- Indicateur de la date s√©lectionn√©e (cach√© si filtre g√©ospatial actif) -->
          <div 
            class="date-indicator"
            [class.draggable]="dateFilterActive"
            [class.dragging]="isDragging"
            *ngIf="selectedDate && !geoFilterActive"
            [style.left.%]="getDatePosition(selectedDate)"
          >
            <div class="indicator-handle"></div>
          </div>
        </div>
      </div>

      <!-- Barres de la frise (seulement si des zones filtr√©es) -->
      <div class="timeline-items-wrapper" *ngIf="filteredZones.length > 0; else noFilteredZones">
        
        <div class="timeline-items">
          <div class="timeline-item" *ngFor="let zone of filteredZones">
            <div class="item-label">
              <input 
                type="checkbox" 
                class="zone-checkbox"
                [checked]="isZoneSelected(zone.id)"
                (change)="toggleZoneSelection(zone.id, $event)"
                (click)="$event.stopPropagation()"
              />
              <span class="item-title">{{ zone.title }}</span>
            </div>

            <div class="item-bar-container" (mouseleave)="onZoneHoverEnd()">
              <div class="item-bar-background"></div>

              <!-- Barre de p√©riode d'installation -->
              <div
                class="item-bar"
                [class.focused]="focusedZoneId === zone.id"
                [style.left.%]="getDatePosition(zone.start)"
                [style.width.%]="getDuration(zone.start, zone.end)"
                (mouseenter)="onZoneHover(zone, $event)"
                (mousemove)="onZoneMouseMove($event)"
                (click)="onZoneClick(zone, $event)"
              ></div>
            </div>
          </div>
        </div>

        <!-- Tooltip dynamique -->
        <div
          class="dynamic-tooltip"
          *ngIf="tooltipVisible && tooltipItem"
          [style.left.px]="tooltipX"
          [style.top.px]="tooltipY"
        >
          <div class="tooltip-title">{{ tooltipItem.title }}</div>
          <div class="tooltip-dates">
            <div class="tooltip-date">
              <span class="date-label">üìå Pose:</span>
              <span class="date-value">{{ formatDateTime(tooltipItem.start) }}</span>
            </div>
            <div class="tooltip-date">
              <span class="date-label">üóëÔ∏è D√©pose:</span>
              <span class="date-value">{{ formatDateTime(tooltipItem.end) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucune zone ne correspond aux filtres -->
      <ng-template #noFilteredZones>
        <div class="no-filtered-zones">
          <p>Aucune zone visible avec les filtres actuels.</p>
        </div>
      </ng-template>
    </div>

    <!-- Aucune zone du tout -->
    <ng-template #noZonesAtAll>
      <div class="no-data">
        <p>Aucun √©quipement avec dates disponible.</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Modale d'assignation d'√©quipe -->
<div class="team-modal-overlay" *ngIf="showTeamModal" (click)="closeTeamModal()">
  <div class="team-modal" (click)="$event.stopPropagation()">
    <div class="team-modal-header">
      <h3>Assigner aux √©quipes</h3>
      <button class="modal-close-btn" (click)="closeTeamModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    <div class="team-modal-body">
      <p class="modal-info">{{ getSelectedCount() }} zone(s) s√©lectionn√©e(s)</p>
      
      <!-- √âquipe de pose -->
      <div class="team-select-container">
        <label for="installationTeamSelect">
          <span class="label-icon">üìå</span>
          √âquipe de pose
        </label>
        <select 
          id="installationTeamSelect" 
          class="team-select"
          [(ngModel)]="selectedInstallationTeamId"
        >
          <option [ngValue]="null">Ne pas modifier</option>
          <option *ngFor="let team of availableTeams" [value]="team.uuid">
            {{ team.teamName }}
          </option>
        </select>
      </div>
      
      <!-- √âquipe de d√©pose -->
      <div class="team-select-container">
        <label for="removalTeamSelect">
          <span class="label-icon">üóëÔ∏è</span>
          √âquipe de d√©pose
        </label>
        <select 
          id="removalTeamSelect" 
          class="team-select"
          [(ngModel)]="selectedRemovalTeamId"
        >
          <option [ngValue]="null">Ne pas modifier</option>
          <option *ngFor="let team of availableTeams" [value]="team.uuid">
            {{ team.teamName }}
          </option>
        </select>
      </div>
      
      <div class="no-teams-message" *ngIf="availableTeams.length === 0">
        <p>Aucune √©quipe disponible pour cet √©v√©nement.</p>
      </div>
    </div>
    
    <div class="team-modal-footer">
      <button class="modal-cancel-btn" (click)="closeTeamModal()">Annuler</button>
      <button 
        class="modal-confirm-btn" 
        [disabled]="!hasTeamSelected() || isAssigning || isEventArchived"
        (click)="assignZonesToTeam()"
      >
        {{ isAssigning ? 'Assignation...' : 'Assigner' }}
      </button>
    </div>
  </div>
</div>
