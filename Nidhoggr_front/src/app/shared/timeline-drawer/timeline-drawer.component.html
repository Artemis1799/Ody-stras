<div class="timeline-container" [class.sidebar-collapsed]="sidebarCollapsed" *ngIf="isVisible">
  <div class="timeline-dialog">
    <!-- Contr√¥les de filtres -->
    <div class="filter-controls">
      <div class="filter-buttons">
        <button 
          class="filter-toggle" 
          [class.active]="dateFilterActive"
          (click)="toggleDateFilter()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          {{ dateFilterActive ? 'Filtre date' : 'Date off' }}
        </button>
        <button 
          class="filter-toggle geo-filter" 
          [class.active]="geoFilterActive"
          (click)="toggleGeoFilter()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          {{ geoFilterActive ? 'Filtre g√©ospatial' : 'G√©ospatial off' }}
        </button>
        <span class="selected-date" *ngIf="selectedDate && dateFilterActive">
          üìÖ {{ formatDateTime(selectedDate) }}
        </span>
      </div>
      <button class="timeline-close" (click)="close()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="timeline-content" *ngIf="allZones.length > 0; else noZonesAtAll">
      <!-- Axe temporel TOUJOURS visible pour permettre le drag -->
      <div 
        class="timeline-axis-wrapper"
        #timelineWrapper
        (mousedown)="onAxisMouseDown($event)"
        (mousemove)="onAxisMouseMove($event)"
        (mouseup)="onAxisMouseUp()"
        (mouseleave)="onAxisMouseUp()"
        [class.dragging-active]="isDragging"
      >
        <div class="timeline-axis-container" #timelineAxis>
          <div class="timeline-graduations">
            <div
              class="graduation"
              *ngFor="let grad of graduations"
              [style.left.%]="grad.position"
              [title]="grad.label"
            >
              <div class="graduation-tick"></div>
              <div class="graduation-label">{{ grad.label }}</div>
            </div>
          </div>
          
          <!-- Indicateur de la date s√©lectionn√©e (cach√© si filtre g√©ospatial actif) -->
          <div 
            class="date-indicator"
            [class.draggable]="dateFilterActive"
            [class.dragging]="isDragging"
            *ngIf="selectedDate && !geoFilterActive"
            [style.left.%]="getDatePosition(selectedDate)"
          >
            <div class="indicator-handle"></div>
          </div>
        </div>
      </div>

      <!-- Barres de la frise (seulement si des zones filtr√©es) -->
      <div class="timeline-items-wrapper" *ngIf="filteredZones.length > 0; else noFilteredZones">
        <div class="timeline-items">
          <div class="timeline-item" *ngFor="let zone of filteredZones">
            <div class="item-label">
              <span class="item-title">{{ zone.title }}</span>
            </div>

            <div class="item-bar-container" (mouseleave)="onZoneHoverEnd()">
              <div class="item-bar-background"></div>

              <!-- Barre de p√©riode d'installation -->
              <div
                class="item-bar"
                [style.left.%]="getDatePosition(zone.start)"
                [style.width.%]="getDuration(zone.start, zone.end)"
                (mouseenter)="onZoneHover(zone, $event)"
                (mousemove)="onZoneMouseMove($event)"
              ></div>
            </div>
          </div>
        </div>

        <!-- Tooltip dynamique -->
        <div
          class="dynamic-tooltip"
          *ngIf="tooltipVisible && tooltipItem"
          [style.left.px]="tooltipX"
          [style.top.px]="tooltipY"
        >
          <div class="tooltip-title">{{ tooltipItem.title }}</div>
          <div class="tooltip-dates">
            <div class="tooltip-date">
              <span class="date-label">üìå Installation:</span>
              <span class="date-value">{{ formatDateTime(tooltipItem.start) }}</span>
            </div>
            <div class="tooltip-date">
              <span class="date-label">üóëÔ∏è Retrait:</span>
              <span class="date-value">{{ formatDateTime(tooltipItem.end) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucune zone ne correspond aux filtres -->
      <ng-template #noFilteredZones>
        <div class="no-filtered-zones">
          <p>Aucune zone visible avec les filtres actuels.</p>
        </div>
      </ng-template>
    </div>

    <!-- Aucune zone du tout -->
    <ng-template #noZonesAtAll>
      <div class="no-data">
        <p>Aucune zone de s√©curit√© avec dates disponible.</p>
      </div>
    </ng-template>
  </div>
</div>
