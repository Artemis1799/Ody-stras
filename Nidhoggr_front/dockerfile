### Multi-stage Dockerfile for Angular (SSR) application
# Build stage: installs dev dependencies and builds the Angular app
FROM node:20-bullseye AS build
WORKDIR /usr/src/app

# Copy just package files first for better layer caching
COPY package.json package-lock.json* ./

# Install dependencies (dev deps needed for the build)
RUN npm install

# Copy source and build
COPY . .

# Build the Angular application (adjust if your project has a different builder/target)
RUN npm run build --if-present


# Runtime stage: smaller image with only production deps and the compiled output
FROM node:20-slim AS runtime
WORKDIR /usr/src/app

ENV NODE_ENV=production
ENV PORT=4000

# Copy compiled application from build stage
COPY --from=build /usr/src/app/dist ./dist

# Copy package.json so we can install only production deps
COPY package.json package-lock.json* ./

# Install only production dependencies (express etc.)
RUN npm install --production

# Expose port used by the SSR server
EXPOSE 4000

# Default command â€” adjust path if your output folder name differs
CMD ["node", "dist/Nidhoggr_front/server/server.mjs"]
